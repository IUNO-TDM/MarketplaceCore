<?xml version="1.0" encoding="utf-8"?><html xmlns:v="urn:schemas-microsoft-com:vml" xmlns:svg="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><head xmlns:svg="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><meta name="vs_targetSchema" content="http://schemas.microsoft.com/intellisense/ie5" /><link rel="stylesheet" href="sqlspec.css" /><title>MarketplaceCore - public.getrevenuehistory</title><script language="JavaScript" src="resort_table.js"></script><script language="javascript">
//
// this hides the SVG if you are on IE, 
// and hides the VML if you are NOT on IE.
//
function init()
{
  var isIE = navigator.userAgent.indexOf("MSIE") != -1;
  showhideIfIE('FK_SVG', isIE, true);
  showhideIfIE('DEPENDENCY_SVG', isIE, true);
  showhideIfIE('MODEL_SVG', isIE, true); 
  showhideIfIE('FK_VML', isIE, false);
  showhideIfIE('DEPENDENCY_VML', isIE, false);
  showhideIfIE('MODEL_VML', isIE, false);
  
  var node = document.getElementById('copy_url_div');
  if (node != null)
  {
    var inChm = document.URL.indexOf('mk:@MSITStore') != -1;
    node.style.display = inChm || !isIE ? 'none' : 'block';
  }
}   

function showhideIfIE(elementName, isIE, hide)
{
  node = document.getElementById(elementName);
  if (node != null) 
  {
    if (hide) 
      node.style.display = isIE ? 'none' : 'block';
    else
      node.style.display = isIE ? 'block' : 'none';
  }
}

function copyToClipboard(s)
{
  if(window.clipboardData)
    if (clipboardData.setData)
      clipboardData.setData('text', s);
}
</script></head><body onload="init()"><div id="nsbanner" xmlns:svg="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><div id="bannerrow1"><table class="bannerparthead" cellspacing="0" id="Table1"><tr id="hdr"><td class="runninghead">Database reference - MarketplaceCore</td><td class="product" /></tr></table></div><div id="TitleRow"><h1 class="dtH1"><a href="default.htm">MarketplaceCore</a> -         
                    <a href="allUDFs.htm">functions</a> -         
                    public.getrevenuehistory</h1></div></div><div id="nstext"><h2 class="dtH2" xmlns:svg="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><font color="red">Evaluation</font></h2><p xmlns:svg="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><font color="red"><b>This is an evaluation version of SqlSpec.  If you like SqlSpec, please consider upgrading to the full version.  Upgrade here:  <a target="_blank" href="http://elsasoft.com">Upgrade</a></b></font></p><h2 class="dtH2">Description</h2><span class="desc">none</span><h2 class="dtH2" xmlns:svg="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><font color="red">Evaluation</font></h2><p xmlns:svg="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><font color="red"><b>This is an evaluation version of SqlSpec.  If you like SqlSpec, please consider upgrading to the full version.  Upgrade here:  <a target="_blank" href="http://elsasoft.com">Upgrade</a></b></font></p><h2 class="dtH2">Function properties</h2><table class="dtTABLE"><thead><tr valign="top"><th style="cursor:pointer;cursor:hand;" onclick="resortColumn(this)">name</th><th style="cursor:pointer;cursor:hand;" onclick="resortColumn(this)">value</th></tr></thead><tbody><tr valign="top"><td>name</td><td>public.getrevenuehistory</td></tr><tr valign="top"><td>return type</td><td>pg_catalog.record 
                  </td></tr><tr valign="top"><td>language</td><td>PLPGSQL</td></tr><tr valign="top"><td>deterministic</td><td>NO</td></tr></tbody></table><h2 class="dtH2" xmlns:svg="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><font color="red">Evaluation</font></h2><p xmlns:svg="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><font color="red"><b>This is an evaluation version of SqlSpec.  If you like SqlSpec, please consider upgrading to the full version.  Upgrade here:  <a target="_blank" href="http://elsasoft.com">Upgrade</a></b></font></p><h2 class="dtH2">Parameters</h2><table class="dtTABLE"><thead><tr valign="top"><th style="cursor:pointer;cursor:hand;" onclick="resortColumn(this)">name</th><th style="cursor:pointer;cursor:hand;" onclick="resortColumn(this)">datatype</th><th style="cursor:pointer;cursor:hand;" onclick="resortColumn(this)">udt</th><th style="cursor:pointer;cursor:hand;" onclick="resortColumn(this)">in/out</th></tr></thead><tbody><tr valign="top"><td>vfrom 
                                            </td><td>timestamp with time zone 
                                            </td><td>pg_catalog.timestamptz 
                                            </td><td>IN 
                                            </td></tr><tr valign="top"><td>vto 
                                            </td><td>timestamp with time zone 
                                            </td><td>pg_catalog.timestamptz 
                                            </td><td>IN 
                                            </td></tr><tr valign="top"><td>vcreatedby 
                                            </td><td>uuid 
                                            </td><td>pg_catalog.uuid 
                                            </td><td>IN 
                                            </td></tr><tr valign="top"><td>vroles 
                                            </td><td>ARRAY 
                                            </td><td>pg_catalog._text 
                                            </td><td>IN 
                                            </td></tr><tr valign="top"><td>date 
                                            </td><td>date 
                                            </td><td>pg_catalog.date 
                                            </td><td>OUT 
                                            </td></tr><tr valign="top"><td>technologydataname 
                                            </td><td>text 
                                            </td><td>pg_catalog.text 
                                            </td><td>OUT 
                                            </td></tr><tr valign="top"><td>revenue 
                                            </td><td>bigint 
                                            </td><td>pg_catalog.int8 
                                            </td><td>OUT 
                                            </td></tr></tbody></table><h2 class="dtH2" xmlns:svg="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><font color="red">Evaluation</font></h2><p xmlns:svg="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><font color="red"><b>This is an evaluation version of SqlSpec.  If you like SqlSpec, please consider upgrading to the full version.  Upgrade here:  <a target="_blank" href="http://elsasoft.com">Upgrade</a></b></font></p><h2 class="dtH2">Usage</h2><pre class="csharpcode"><span class="kwrd">result</span> = <span class="kwrd">public</span>.getrevenuehistory(
    my_vfrom,
    my_vto,
    my_vcreatedby,
    my_vroles,
    my_date,
    my_technologydataname,
    my_revenue
);</pre><h2 class="dtH2" xmlns:svg="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><font color="red">Evaluation</font></h2><p xmlns:svg="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><font color="red"><b>This is an evaluation version of SqlSpec.  If you like SqlSpec, please consider upgrading to the full version.  Upgrade here:  <a target="_blank" href="http://elsasoft.com">Upgrade</a></b></font></p><h2 class="dtH2">Code</h2><pre class="csharpcode"><span class="kwrd">CREATE</span> <span class="kwrd">FUNCTION</span> getrevenuehistory(vfrom <span class="kwrd">timestamp</span> <span class="kwrd">with</span> <span class="kwrd">time</span> <span class="kwrd">zone</span>, vto <span class="kwrd">timestamp</span> <span class="kwrd">with</span> <span class="kwrd">time</span> <span class="kwrd">zone</span>, vcreatedby uuid, vroles text[]) <span class="kwrd">RETURNS</span> <span class="kwrd">TABLE</span>(<span class="kwrd">date</span> <span class="kwrd">date</span>, technologydataname text, revenue bigint)
    <span class="kwrd">LANGUAGE</span> plpgsql
    <span class="kwrd">AS</span> $$



            <span class="kwrd">DECLARE</span>

                vFunctionName <span class="kwrd">varchar</span> := <span class="str">'GetRevenueHistory'</span>; 

                vIsAllowed <span class="kwrd">boolean</span> := (<span class="kwrd">select</span> <span class="kwrd">public</span>.checkPermissions(vRoles, vFunctionName));        



            <span class="kwrd">BEGIN</span> 



            <span class="kwrd">IF</span>(vIsAllowed) <span class="kwrd">THEN</span>



            <span class="kwrd">RETURN</span> QUERY (<span class="kwrd">with</span> basis <span class="kwrd">as</span> (<span class="kwrd">select</span> r.<span class="kwrd">year</span>, r.<span class="kwrd">month</span>, r.<span class="kwrd">day</span>, r.<span class="kwrd">hour</span>, <span class="kwrd">coalesce</span>(td.technologydataname,<span class="str">'Total'</span>)::text <span class="kwrd">as</span> technologydataname, r.amount, r.revenue, r.average  <span class="kwrd">from</span> <span class="kwrd">public</span>.getrevenue(

                        vfrom,

                        vto,

                        <span class="kwrd">null</span>,

                        vcreatedby,

                        vroles) r

                    <span class="kwrd">join</span> technologydata td <span class="kwrd">on</span> td.technologydatauuid = r.technologydatauuid

                    <span class="kwrd">where</span> r.<span class="kwrd">year</span> &lt;&gt; <span class="str">'0'</span> <span class="kwrd">and</span> r.<span class="kwrd">month</span> &lt;&gt; <span class="str">'0'</span> <span class="kwrd">and</span> r.<span class="kwrd">day</span> &lt;&gt; <span class="str">'0'</span> <span class="kwrd">and</span> r.<span class="kwrd">hour</span> &lt;&gt; <span class="str">'0'</span>

                    <span class="kwrd">and</span> r.technologydatauuid &lt;&gt; uuid_nil()

                    <span class="kwrd">order</span> <span class="kwrd">by</span> r.<span class="kwrd">year</span>, r.<span class="kwrd">month</span>, r.<span class="kwrd">day</span>, r.<span class="kwrd">hour</span>, td.technologydatauuid),

                    benchmark <span class="kwrd">as</span> (

                    <span class="kwrd">select</span> r.<span class="kwrd">year</span>, r.<span class="kwrd">month</span>, r.<span class="kwrd">day</span>, <span class="str">'Benchmark'</span>::text <span class="kwrd">as</span> technologydataname, (r.revenue / r.amount) <span class="kwrd">as</span> revenue <span class="kwrd">from</span> <span class="kwrd">public</span>.getrevenue(

                        vfrom,

                        vto,

                        <span class="kwrd">null</span>,

                        <span class="kwrd">null</span>,

                        vroles) r 

                    <span class="kwrd">where</span> r.<span class="kwrd">year</span> &lt;&gt; <span class="str">'0'</span> <span class="kwrd">and</span> r.<span class="kwrd">month</span> &lt;&gt; <span class="str">'0'</span> <span class="kwrd">and</span> r.<span class="kwrd">day</span> &lt;&gt; <span class="str">'0'</span> <span class="kwrd">and</span> r.<span class="kwrd">hour</span> = <span class="str">'0'</span>

                    <span class="kwrd">and</span> r.technologydatauuid = uuid_nil()

                    <span class="kwrd">group</span> <span class="kwrd">by</span> r.<span class="kwrd">year</span>, r.<span class="kwrd">month</span>, r.<span class="kwrd">day</span>, r.revenue, r.amount             

                    ),

                    techName <span class="kwrd">as</span> (<span class="kwrd">select</span> <span class="kwrd">distinct</span> a.technologydataname

                            <span class="kwrd">from</span> basis a),            

                    dates <span class="kwrd">as</span> (<span class="kwrd">select</span> <span class="kwrd">distinct</span> a.<span class="kwrd">year</span>, a.<span class="kwrd">month</span>, a.<span class="kwrd">day</span>

                            <span class="kwrd">from</span> benchmark a ),                            

                    allData <span class="kwrd">as</span> (<span class="kwrd">select</span> tn.technologydataname, dt.<span class="kwrd">year</span>, dt.<span class="kwrd">month</span>, dt.<span class="kwrd">day</span>

                            <span class="kwrd">from</span> techname tn, dates dt),

                    totalData <span class="kwrd">as</span> (<span class="kwrd">select</span> ad.<span class="kwrd">year</span>, ad.<span class="kwrd">month</span>, ad.<span class="kwrd">day</span>, ad.technologydataname, <span class="kwrd">case</span> <span class="kwrd">when</span> (ba.revenue <span class="kwrd">is</span> <span class="kwrd">null</span>) <span class="kwrd">then</span> 0::bigint <span class="kwrd">else</span> ba.revenue::bigint <span class="kwrd">end</span> <span class="kwrd">as</span> revenue

                        <span class="kwrd">from</span> allData ad

                        <span class="kwrd">left</span> <span class="kwrd">outer</span> <span class="kwrd">join</span> basis ba

                        <span class="kwrd">on</span> ad.<span class="kwrd">year</span> = ba.<span class="kwrd">year</span>

                        <span class="kwrd">and</span> ad.<span class="kwrd">month</span> = ba.<span class="kwrd">month</span>

                        <span class="kwrd">and</span> ad.<span class="kwrd">day</span> = ba.<span class="kwrd">day</span>

                        <span class="kwrd">and</span> ad.technologydataname = ba.technologydataname),

                    <span class="kwrd">result</span> <span class="kwrd">as</span> (            

                    <span class="kwrd">select</span> to_date(t.<span class="kwrd">year</span> || <span class="str">'-'</span> || t.<span class="kwrd">month</span> || <span class="str">'-'</span> || t.<span class="kwrd">day</span>, <span class="str">'YYYY-MM-DD'</span>) <span class="kwrd">as</span> <span class="kwrd">date</span>, t.technologydataname, t.revenue::bigint <span class="kwrd">from</span> totalData t            <span class="kwrd">union</span> <span class="kwrd">all</span> 

                    <span class="kwrd">select</span> to_date(b.<span class="kwrd">year</span> || <span class="str">'-'</span> || b.<span class="kwrd">month</span> || <span class="str">'-'</span> || b.<span class="kwrd">day</span>, <span class="str">'YYYY-MM-DD'</span>) <span class="kwrd">as</span> <span class="kwrd">date</span>, b.technologydataname, b.revenue::bigint <span class="kwrd">from</span> benchmark b)

                    <span class="kwrd">select</span> rs.<span class="kwrd">date</span>, rs.technologydataname, <span class="kwrd">sum</span>(rs.revenue)::bigint <span class="kwrd">from</span> <span class="kwrd">result</span> rs

                    <span class="kwrd">group</span> <span class="kwrd">by</span> rs.<span class="kwrd">date</span>, rs.technologydataname

                    <span class="kwrd">order</span> <span class="kwrd">by</span> rs.<span class="kwrd">date</span> <span class="kwrd">asc</span>

                     

                

                );

            <span class="kwrd">ELSE</span>

                 RAISE <span class="kwrd">EXCEPTION</span> <span class="str">'%'</span>, <span class="str">'Insufficiency rigths'</span>;

                 <span class="kwrd">RETURN</span>;

            <span class="kwrd">END</span> <span class="kwrd">IF</span>;



            <span class="kwrd">END</span>;

        $$;


</pre></div><p style="page-break-after:always" xmlns:svg="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><br /><br /><div id="copy_url_div"><center><a href="javascript:void(0)" onclick="copyToClipboard(document.URL)">copy URL to clipboard (IE only)</a></center><br /></div><center>Documentation generated by <a target="_blank" href="http://elsasoft.com">SqlSpec</a></center></p></body></html>